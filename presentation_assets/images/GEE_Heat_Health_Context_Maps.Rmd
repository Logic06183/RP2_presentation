---
title: "Google Earth Engine Heat Health Context Maps: Johannesburg & Abidjan"
author: "Heat Health Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: united
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 8
)

# Load required libraries
library(rgee)
library(sf)
library(tidyverse)
library(leaflet)
library(viridis)
library(patchwork)
library(raster)
library(stars)

# Initialize Earth Engine
ee_Initialize(user = 'your_email@gmail.com', drive = TRUE)
```

## 1. Study Area Definition

```{r define_areas}
# Define city boundaries
johannesburg_coords <- c(27.9, -26.3, 28.3, -26.0)  # xmin, ymin, xmax, ymax
abidjan_coords <- c(-4.2, 5.2, -3.8, 5.5)

# Create Earth Engine geometries
johannesburg_ee <- ee$Geometry$Rectangle(johannesburg_coords)
abidjan_ee <- ee$Geometry$Rectangle(abidjan_coords)

# Create a combined geometry for comparative analysis
cities_combined <- ee$FeatureCollection(list(
  ee$Feature(johannesburg_ee, list(city = "Johannesburg")),
  ee$Feature(abidjan_ee, list(city = "Abidjan"))
))

print("Study areas defined successfully")
```

## 2. Land Surface Temperature Analysis

```{r lst_analysis}
# Function to get LST data
get_lst_data <- function(geometry, city_name, start_date = "2023-01-01", end_date = "2023-12-31") {
  
  # Use MODIS Land Surface Temperature
  lst <- ee$ImageCollection("MODIS/061/MOD11A1")$
    filterDate(start_date, end_date)$
    filterBounds(geometry)$
    select("LST_Day_1km")
  
  # Calculate mean LST and convert from Kelvin to Celsius
  lst_mean <- lst$mean()$
    multiply(0.02)$
    subtract(273.15)$
    clip(geometry)
  
  # Calculate LST statistics
  lst_stats <- lst_mean$reduceRegion(
    reducer = ee$Reducer$percentile(c(25, 50, 75, 90, 95)),
    geometry = geometry,
    scale = 1000,
    maxPixels = 1e9
  )
  
  return(list(
    image = lst_mean,
    stats = lst_stats,
    city = city_name
  ))
}

# Get LST data for both cities
johannesburg_lst <- get_lst_data(johannesburg_ee, "Johannesburg")
abidjan_lst <- get_lst_data(abidjan_ee, "Abidjan")

# Visualize LST
lst_viz_params <- list(
  min = 20,
  max = 45,
  palette = c('#0000FF', '#00FFFF', '#00FF00', '#FFFF00', '#FF8C00', '#FF0000')
)

# Create interactive maps
Map$centerObject(johannesburg_ee, zoom = 10)
johannesburg_lst_map <- Map$addLayer(
  johannesburg_lst$image,
  lst_viz_params,
  "LST Johannesburg"
)

Map$centerObject(abidjan_ee, zoom = 10)
abidjan_lst_map <- Map$addLayer(
  abidjan_lst$image,
  lst_viz_params,
  "LST Abidjan"
)

print("Land Surface Temperature analysis complete")
```

## 3. Vegetation Index (NDVI) Analysis

```{r ndvi_analysis}
# Function to calculate NDVI
calculate_ndvi <- function(geometry, city_name, year = 2023) {
  
  # Use Sentinel-2 for higher resolution
  sentinel2 <- ee$ImageCollection("COPERNICUS/S2_SR_HARMONIZED")$
    filterDate(paste0(year, "-01-01"), paste0(year, "-12-31"))$
    filterBounds(geometry)$
    filter(ee$Filter$lt("CLOUDY_PIXEL_PERCENTAGE", 10))
  
  # Calculate median composite
  composite <- sentinel2$median()$clip(geometry)
  
  # Calculate NDVI
  ndvi <- composite$normalizedDifference(c("B8", "B4"))$rename("NDVI")
  
  # Calculate vegetation statistics
  ndvi_stats <- ndvi$reduceRegion(
    reducer = ee$Reducer$histogram(50, -1, 1),
    geometry = geometry,
    scale = 100,
    maxPixels = 1e9
  )
  
  return(list(
    image = ndvi,
    composite = composite,
    stats = ndvi_stats,
    city = city_name
  ))
}

# Calculate NDVI for both cities
johannesburg_ndvi <- calculate_ndvi(johannesburg_ee, "Johannesburg")
abidjan_ndvi <- calculate_ndvi(abidjan_ee, "Abidjan")

# NDVI visualization parameters
ndvi_viz <- list(
  min = -0.2,
  max = 0.8,
  palette = c('#FF0000', '#FFFF00', '#00FF00', '#008000', '#004000')
)

# Add NDVI layers to map
Map$centerObject(johannesburg_ee, zoom = 10)
johannesburg_ndvi_map <- Map$addLayer(
  johannesburg_ndvi$image,
  ndvi_viz,
  "NDVI Johannesburg"
)

Map$centerObject(abidjan_ee, zoom = 10)
abidjan_ndvi_map <- Map$addLayer(
  abidjan_ndvi$image,
  ndvi_viz,
  "NDVI Abidjan"
)

print("NDVI analysis complete")
```

## 4. Urban Heat Island Analysis

```{r uhi_analysis}
# Function to calculate Urban Heat Island intensity
calculate_uhi <- function(geometry, city_name) {
  
  # Get LST data
  lst <- ee$ImageCollection("MODIS/061/MOD11A1")$
    filterDate("2023-06-01", "2023-08-31")$  # Summer months
    filterBounds(geometry)$
    select("LST_Day_1km")
  
  # Calculate mean summer LST
  lst_summer <- lst$mean()$
    multiply(0.02)$
    subtract(273.15)$
    clip(geometry)
  
  # Get impervious surface data
  impervious <- ee$ImageCollection("COPERNICUS/Landcover/100m/Proba-V-C3/Global")$
    select("urban-coverfraction")$
    first()$
    clip(geometry)
  
  # Calculate UHI intensity (correlation between LST and urban fraction)
  uhi_composite <- ee$Image$cat(lst_summer, impervious)$
    rename(c("LST", "Urban_Fraction"))
  
  return(list(
    lst = lst_summer,
    impervious = impervious,
    composite = uhi_composite,
    city = city_name
  ))
}

# Calculate UHI for both cities
johannesburg_uhi <- calculate_uhi(johannesburg_ee, "Johannesburg")
abidjan_uhi <- calculate_uhi(abidjan_ee, "Abidjan")

# Visualize UHI
urban_viz <- list(
  min = 0,
  max = 100,
  palette = c('#FFFFFF', '#FFE5CC', '#FFCC99', '#FF9966', '#FF6633', '#CC0000')
)

# Create UHI maps
Map$centerObject(johannesburg_ee, zoom = 10)
johannesburg_uhi_map <- Map$addLayer(
  johannesburg_uhi$impervious,
  urban_viz,
  "Urban Fraction Johannesburg"
) + Map$addLayer(
  johannesburg_uhi$lst,
  lst_viz_params,
  "Summer LST Johannesburg"
)

Map$centerObject(abidjan_ee, zoom = 10)
abidjan_uhi_map <- Map$addLayer(
  abidjan_uhi$impervious,
  urban_viz,
  "Urban Fraction Abidjan"
) + Map$addLayer(
  abidjan_uhi$lst,
  lst_viz_params,
  "Summer LST Abidjan"
)

print("Urban Heat Island analysis complete")
```

## 5. Nighttime Lights Analysis

```{r nightlights}
# Function to analyze nighttime lights
analyze_nightlights <- function(geometry, city_name) {
  
  # Use VIIRS nighttime lights
  viirs <- ee$ImageCollection("NOAA/VIIRS/DNB/MONTHLY_V1/VCMSLCFG")$
    filterDate("2023-01-01", "2023-12-31")$
    filterBounds(geometry)$
    select("avg_rad")
  
  # Calculate median nighttime lights
  nightlights_median <- viirs$median()$clip(geometry)
  
  # Calculate statistics
  nl_stats <- nightlights_median$reduceRegion(
    reducer = ee$Reducer$percentile(c(25, 50, 75, 90, 95)),
    geometry = geometry,
    scale = 500,
    maxPixels = 1e9
  )
  
  return(list(
    image = nightlights_median,
    stats = nl_stats,
    city = city_name
  ))
}

# Analyze nighttime lights for both cities
johannesburg_nl <- analyze_nightlights(johannesburg_ee, "Johannesburg")
abidjan_nl <- analyze_nightlights(abidjan_ee, "Abidjan")

# Nighttime lights visualization
nl_viz <- list(
  min = 0,
  max = 60,
  palette = c('#000000', '#0000FF', '#00FFFF', '#FFFF00', '#FFA500', '#FF0000')
)

# Create nighttime lights maps
Map$centerObject(johannesburg_ee, zoom = 10)
johannesburg_nl_map <- Map$addLayer(
  johannesburg_nl$image,
  nl_viz,
  "Nighttime Lights Johannesburg"
)

Map$centerObject(abidjan_ee, zoom = 10)
abidjan_nl_map <- Map$addLayer(
  abidjan_nl$image,
  nl_viz,
  "Nighttime Lights Abidjan"
)

print("Nighttime lights analysis complete")
```

## 6. Population Density Visualization

```{r population}
# Function to get population density
get_population_density <- function(geometry, city_name) {
  
  # Use WorldPop population density
  population <- ee$ImageCollection("WorldPop/GP/100m/pop")$
    filterBounds(geometry)$
    first()$
    clip(geometry)
  
  # Calculate population statistics
  pop_stats <- population$reduceRegion(
    reducer = ee$Reducer$sum(),
    geometry = geometry,
    scale = 100,
    maxPixels = 1e9
  )
  
  return(list(
    image = population,
    stats = pop_stats,
    city = city_name
  ))
}

# Get population density for both cities
johannesburg_pop <- get_population_density(johannesburg_ee, "Johannesburg")
abidjan_pop <- get_population_density(abidjan_ee, "Abidjan")

# Population visualization
pop_viz <- list(
  min = 0,
  max = 1000,
  palette = c('#FFFFFF', '#FFFFCC', '#FFEDA0', '#FED976', '#FEB24C', '#FD8D3C', '#FC4E2A', '#E31A1C', '#B10026')
)

# Create population density maps
Map$centerObject(johannesburg_ee, zoom = 10)
johannesburg_pop_map <- Map$addLayer(
  johannesburg_pop$image,
  pop_viz,
  "Population Density Johannesburg"
)

Map$centerObject(abidjan_ee, zoom = 10)
abidjan_pop_map <- Map$addLayer(
  abidjan_pop$image,
  pop_viz,
  "Population Density Abidjan"
)

print("Population density analysis complete")
```

## 7. Air Quality (NO2) Analysis

```{r air_quality}
# Function to analyze NO2 levels
analyze_no2 <- function(geometry, city_name) {
  
  # Use Sentinel-5P TROPOMI NO2 data
  no2 <- ee$ImageCollection("COPERNICUS/S5P/NRTI/L3_NO2")$
    filterDate("2023-01-01", "2023-12-31")$
    filterBounds(geometry)$
    select("NO2_column_number_density")
  
  # Calculate mean NO2 levels
  no2_mean <- no2$mean()$clip(geometry)
  
  # Calculate statistics
  no2_stats <- no2_mean$reduceRegion(
    reducer = ee$Reducer$percentile(c(25, 50, 75, 90, 95)),
    geometry = geometry,
    scale = 1000,
    maxPixels = 1e9
  )
  
  return(list(
    image = no2_mean,
    stats = no2_stats,
    city = city_name
  ))
}

# Analyze NO2 for both cities
johannesburg_no2 <- analyze_no2(johannesburg_ee, "Johannesburg")
abidjan_no2 <- analyze_no2(abidjan_ee, "Abidjan")

# NO2 visualization
no2_viz <- list(
  min = 0,
  max = 0.0002,
  palette = c('#0000FF', '#00FF00', '#FFFF00', '#FFA500', '#FF0000', '#8B0000')
)

# Create NO2 maps
Map$centerObject(johannesburg_ee, zoom = 10)
johannesburg_no2_map <- Map$addLayer(
  johannesburg_no2$image,
  no2_viz,
  "NO2 Levels Johannesburg"
)

Map$centerObject(abidjan_ee, zoom = 10)
abidjan_no2_map <- Map$addLayer(
  abidjan_no2$image,
  no2_viz,
  "NO2 Levels Abidjan"
)

print("Air quality analysis complete")
```

## 8. Heat Vulnerability Index Components

```{r hvi_components}
# Function to create Heat Vulnerability Index components
create_hvi_components <- function(geometry, city_name) {
  
  # Get all relevant layers
  lst <- ee$ImageCollection("MODIS/061/MOD11A1")$
    filterDate("2023-06-01", "2023-08-31")$
    filterBounds(geometry)$
    select("LST_Day_1km")$
    mean()$
    multiply(0.02)$
    subtract(273.15)
  
  ndvi <- ee$ImageCollection("COPERNICUS/S2_SR_HARMONIZED")$
    filterDate("2023-01-01", "2023-12-31")$
    filterBounds(geometry)$
    filter(ee$Filter$lt("CLOUDY_PIXEL_PERCENTAGE", 10))$
    median()$
    normalizedDifference(c("B8", "B4"))
  
  population <- ee$ImageCollection("WorldPop/GP/100m/pop")$
    filterBounds(geometry)$
    first()
  
  impervious <- ee$ImageCollection("COPERNICUS/Landcover/100m/Proba-V-C3/Global")$
    select("urban-coverfraction")$
    first()
  
  # Normalize all layers to 0-1 scale
  lst_norm <- lst$unitScale(20, 45)$clip(geometry)
  ndvi_norm <- ndvi$multiply(-1)$add(1)$multiply(0.5)$clip(geometry)  # Invert NDVI (less vegetation = higher vulnerability)
  pop_norm <- population$unitScale(0, 1000)$clip(geometry)
  imperv_norm <- impervious$divide(100)$clip(geometry)
  
  # Create composite HVI (simplified version)
  hvi <- lst_norm$multiply(0.3)$
    add(ndvi_norm$multiply(0.2))$
    add(pop_norm$multiply(0.3))$
    add(imperv_norm$multiply(0.2))$
    rename("HVI")
  
  return(list(
    hvi = hvi,
    lst_norm = lst_norm,
    ndvi_norm = ndvi_norm,
    pop_norm = pop_norm,
    imperv_norm = imperv_norm,
    city = city_name
  ))
}

# Create HVI for both cities
johannesburg_hvi <- create_hvi_components(johannesburg_ee, "Johannesburg")
abidjan_hvi <- create_hvi_components(abidjan_ee, "Abidjan")

# HVI visualization
hvi_viz <- list(
  min = 0,
  max = 1,
  palette = c('#00FF00', '#90EE90', '#FFFF00', '#FFA500', '#FF4500', '#8B0000')
)

# Create HVI maps
Map$centerObject(johannesburg_ee, zoom = 10)
johannesburg_hvi_map <- Map$addLayer(
  johannesburg_hvi$hvi,
  hvi_viz,
  "Heat Vulnerability Index Johannesburg"
)

Map$centerObject(abidjan_ee, zoom = 10)
abidjan_hvi_map <- Map$addLayer(
  abidjan_hvi$hvi,
  hvi_viz,
  "Heat Vulnerability Index Abidjan"
)

print("Heat Vulnerability Index analysis complete")
```

## 9. Export High-Resolution Maps

```{r export_maps}
# Function to export maps as images
export_map <- function(image, geometry, city_name, layer_name, scale = 100) {
  
  # Define export parameters
  export_params <- list(
    image = image,
    description = paste0(city_name, "_", layer_name),
    folder = "GEE_Heat_Health_Maps",
    fileNamePrefix = paste0(city_name, "_", layer_name),
    region = geometry,
    scale = scale,
    maxPixels = 1e9
  )
  
  # Create export task
  task <- ee_image_to_drive(
    image = image,
    description = export_params$description,
    folder = export_params$folder,
    fileNamePrefix = export_params$fileNamePrefix,
    region = geometry,
    scale = scale,
    maxPixels = 1e9
  )
  
  task$start()
  
  return(task)
}

# Export key layers for both cities
exports <- list(
  export_map(johannesburg_lst$image, johannesburg_ee, "Johannesburg", "LST", 1000),
  export_map(abidjan_lst$image, abidjan_ee, "Abidjan", "LST", 1000),
  export_map(johannesburg_ndvi$image, johannesburg_ee, "Johannesburg", "NDVI", 100),
  export_map(abidjan_ndvi$image, abidjan_ee, "Abidjan", "NDVI", 100),
  export_map(johannesburg_hvi$hvi, johannesburg_ee, "Johannesburg", "HVI", 100),
  export_map(abidjan_hvi$hvi, abidjan_ee, "Abidjan", "HVI", 100)
)

print("Export tasks initiated. Check Google Drive for results.")
```

## 10. Create Comparison Visualizations

```{r comparison_plots}
# Function to download and plot comparison
create_comparison_plot <- function(johannesburg_data, abidjan_data, title) {
  
  # This would normally download the data and create side-by-side plots
  # For demonstration, we'll create a placeholder
  
  plot_title <- paste("Comparison:", title)
  
  # Create a simple comparison message
  comparison <- data.frame(
    City = c("Johannesburg", "Abidjan"),
    Analysis = c("Complete", "Complete"),
    Layer = title
  )
  
  print(comparison)
  
  return(comparison)
}

# Create comparisons for each analysis
comparisons <- list(
  create_comparison_plot(johannesburg_lst, abidjan_lst, "Land Surface Temperature"),
  create_comparison_plot(johannesburg_ndvi, abidjan_ndvi, "Vegetation Index"),
  create_comparison_plot(johannesburg_uhi, abidjan_uhi, "Urban Heat Island"),
  create_comparison_plot(johannesburg_nl, abidjan_nl, "Nighttime Lights"),
  create_comparison_plot(johannesburg_pop, abidjan_pop, "Population Density"),
  create_comparison_plot(johannesburg_no2, abidjan_no2, "Air Quality (NO2)"),
  create_comparison_plot(johannesburg_hvi, abidjan_hvi, "Heat Vulnerability Index")
)

print("All analyses complete!")
```

## Summary

This notebook has generated comprehensive contextual maps for heat health analysis in Johannesburg and Abidjan, including:

1. **Land Surface Temperature**: Shows thermal patterns and heat hotspots
2. **Vegetation Index (NDVI)**: Identifies green spaces that provide cooling
3. **Urban Heat Island**: Reveals intensity of urban heating effects
4. **Nighttime Lights**: Proxy for economic activity and energy use
5. **Population Density**: Identifies areas with high exposure
6. **Air Quality (NO2)**: Shows pollution patterns that compound heat stress
7. **Heat Vulnerability Index**: Composite measure combining multiple factors

All maps have been exported to Google Drive for use in presentations and further analysis.