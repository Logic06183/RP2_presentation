#!/usr/bin/env Rscript
# Create vulnerability maps for Southern Africa using Natural Earth boundaries
# Showing ND-GAIN vulnerability with climate stress indicators

# Load required libraries
suppressPackageStartupMessages({
  library(sf)
  library(ggplot2)
  library(dplyr)
  library(scales)
  library(rnaturalearth)
  library(rnaturalearthdata)
  library(viridis)
  library(patchwork)
})

# Southern Africa vulnerability and climate data
vulnerability_data <- data.frame(
  country = c("South Africa", "Zimbabwe", "Malawi", "Botswana", "Namibia", 
              "Zambia", "Mozambique", "Angola", "Lesotho", "Eswatini"),
  iso_a3 = c("ZAF", "ZWE", "MWI", "BWA", "NAM", "ZMB", "MOZ", "AGO", "LSO", "SWZ"),
  vulnerability = c(0.422, 0.523, 0.548, 0.438, 0.456, 0.532, 0.571, 0.551, 0.485, 0.471),
  readiness = c(0.426, 0.301, 0.336, 0.458, 0.411, 0.349, 0.296, 0.294, 0.348, 0.372),
  temp_stress_2050 = c(3.2, 3.1, 2.9, 3.4, 3.6, 3.0, 2.7, 3.1, 3.3, 3.2),
  precip_stress_2050 = c(-22, -28, -20, -32, -35, -24, -18, -16, -25, -21),
  target_country = c(TRUE, TRUE, TRUE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, FALSE),
  stringsAsFactors = FALSE
)

# Calculate composite risk score
vulnerability_data <- vulnerability_data %>%
  mutate(
    # Normalize climate stress (higher = worse)
    temp_norm = (temp_stress_2050 - min(temp_stress_2050)) / (max(temp_stress_2050) - min(temp_stress_2050)),
    precip_norm = (abs(precip_stress_2050) - min(abs(precip_stress_2050))) / 
                  (max(abs(precip_stress_2050)) - min(abs(precip_stress_2050))),
    climate_stress = (temp_norm + precip_norm) / 2,
    # Combined risk = vulnerability * climate_stress / readiness
    risk_score = (vulnerability * (1 + climate_stress)) / (readiness + 0.1) # +0.1 to avoid division by zero
  )

# Publication theme
theme_publication <- function() {
  theme_minimal() +
    theme(
      text = element_text(size = 12),
      plot.title = element_text(size = 14, hjust = 0.5, face = "bold"),
      plot.subtitle = element_text(size = 12, hjust = 0.5, color = "gray30"),
      axis.text = element_text(size = 10),
      axis.title = element_text(size = 11),
      legend.title = element_text(size = 11, face = "bold"),
      legend.text = element_text(size = 10),
      legend.position = "right",
      legend.key.size = unit(0.8, "cm"),
      panel.grid = element_blank(),
      panel.background = element_rect(fill = "white", color = NA),
      plot.background = element_rect(fill = "white", color = NA),
      axis.ticks = element_blank(),
      axis.text.x = element_blank(),
      axis.text.y = element_blank()
    )
}

create_vulnerability_map <- function() {
  tryCatch({
    cat("Creating vulnerability map...\n")
    
    # Get Natural Earth country boundaries
    countries <- ne_countries(scale = "medium", returnclass = "sf")
    
    # Filter for Southern Africa region
    southern_africa_iso <- c("ZAF", "ZWE", "MWI", "BWA", "NAM", "ZMB", 
                           "MOZ", "AGO", "LSO", "SWZ", "MDG")
    
    countries_sa <- countries %>%
      filter(iso_a3 %in% southern_africa_iso)
    
    # Join with vulnerability data
    countries_vuln <- countries_sa %>%
      left_join(vulnerability_data, by = "iso_a3") %>%
      mutate(
        vulnerability = ifelse(is.na(vulnerability), 0.4, vulnerability),
        target_country = ifelse(is.na(target_country), FALSE, target_country)
      )
    
    # Create the vulnerability map
    p1 <- ggplot(countries_vuln) +
      # Fill countries with vulnerability colors
      geom_sf(aes(fill = vulnerability), color = "white", size = 0.3) +
      # Highlight target countries with thick borders
      geom_sf(data = countries_vuln %>% filter(target_country == TRUE),
              fill = NA, color = "black", size = 1.5) +
      # Color scale
      scale_fill_gradient2(
        name = "ND-GAIN\nVulnerability",
        low = "#2166ac", mid = "#f7f7f7", high = "#d73027",
        midpoint = 0.45,
        breaks = c(0.3, 0.4, 0.5, 0.6),
        labels = c("0.30\n(Lower)", "0.40", "0.50", "0.60\n(Higher)"),
        limits = c(0.3, 0.6),
        guide = guide_colorbar(
          direction = "vertical",
          barwidth = 1,
          barheight = 6,
          title.position = "top",
          title.hjust = 0.5
        )
      ) +
      coord_sf(xlim = c(10, 42), ylim = c(-35, -8), expand = FALSE) +
      labs(
        title = "Climate Vulnerability (ND-GAIN 2023)",
        subtitle = "Lower values indicate higher vulnerability"
      ) +
      theme_publication()
    
    # Add vulnerability scores for target countries
    target_centroids <- countries_vuln %>%
      filter(target_country == TRUE) %>%
      st_centroid() %>%
      mutate(
        lon = st_coordinates(.)[,1],
        lat = st_coordinates(.)[,2]
      ) %>%
      st_drop_geometry()
    
    if (nrow(target_centroids) > 0) {
      p1 <- p1 + 
        geom_text(data = target_centroids,
                  aes(x = lon, y = lat, label = sprintf("%.3f", vulnerability)),
                  color = "white", fontface = "bold", size = 3,
                  stroke = 0.3, stroke_color = "black")
    }
    
    return(p1)
    
  }, error = function(e) {
    cat(sprintf("Error creating vulnerability map: %s\n", e$message))
    return(NULL)
  })
}

create_risk_map <- function() {
  tryCatch({
    cat("Creating composite risk map...\n")
    
    # Get Natural Earth country boundaries
    countries <- ne_countries(scale = "medium", returnclass = "sf")
    
    # Filter for Southern Africa region
    southern_africa_iso <- c("ZAF", "ZWE", "MWI", "BWA", "NAM", "ZMB", 
                           "MOZ", "AGO", "LSO", "SWZ", "MDG")
    
    countries_sa <- countries %>%
      filter(iso_a3 %in% southern_africa_iso)
    
    # Join with vulnerability data
    countries_risk <- countries_sa %>%
      left_join(vulnerability_data, by = "iso_a3") %>%
      mutate(
        risk_score = ifelse(is.na(risk_score), 1.0, risk_score),
        target_country = ifelse(is.na(target_country), FALSE, target_country)
      )
    
    # Create the risk map
    p2 <- ggplot(countries_risk) +
      # Fill countries with risk colors
      geom_sf(aes(fill = risk_score), color = "white", size = 0.3) +
      # Highlight target countries with thick borders
      geom_sf(data = countries_risk %>% filter(target_country == TRUE),
              fill = NA, color = "black", size = 1.5) +
      # Color scale
      scale_fill_gradient(
        name = "Composite\nRisk Score",
        low = "#ffffcc", high = "#800026",
        breaks = c(1, 2, 3, 4),
        labels = c("Low", "Moderate", "High", "Critical"),
        guide = guide_colorbar(
          direction = "vertical",
          barwidth = 1,
          barheight = 6,
          title.position = "top",
          title.hjust = 0.5
        )
      ) +
      coord_sf(xlim = c(10, 42), ylim = c(-35, -8), expand = FALSE) +
      labs(
        title = "Integrated Climate Risk",
        subtitle = "Vulnerability × Climate Stress ÷ Readiness"
      ) +
      theme_publication()
    
    # Add risk scores for target countries
    target_centroids <- countries_risk %>%
      filter(target_country == TRUE) %>%
      st_centroid() %>%
      mutate(
        lon = st_coordinates(.)[,1],
        lat = st_coordinates(.)[,2]
      ) %>%
      st_drop_geometry()
    
    if (nrow(target_centroids) > 0) {
      p2 <- p2 + 
        geom_text(data = target_centroids,
                  aes(x = lon, y = lat, label = sprintf("%.1f", risk_score)),
                  color = "white", fontface = "bold", size = 3,
                  stroke = 0.3, stroke_color = "black")
    }
    
    return(p2)
    
  }, error = function(e) {
    cat(sprintf("Error creating risk map: %s\n", e$message))
    return(NULL)
  })
}

create_scatter_plot <- function() {
  tryCatch({
    cat("Creating vulnerability scatter plot...\n")
    
    target_data <- vulnerability_data %>%
      filter(target_country == TRUE)
    
    other_data <- vulnerability_data %>%
      filter(target_country == FALSE)
    
    p3 <- ggplot() +
      # Other countries
      geom_point(data = other_data,
                 aes(x = readiness, y = vulnerability),
                 color = "gray60", size = 3, alpha = 0.7) +
      geom_text(data = other_data,
                aes(x = readiness, y = vulnerability, label = iso_a3),
                color = "gray50", size = 2.5, hjust = -0.2, vjust = -0.2) +
      # Target countries
      geom_point(data = target_data,
                 aes(x = readiness, y = vulnerability, fill = risk_score),
                 size = 6, shape = 21, stroke = 2, color = "black") +
      geom_text(data = target_data,
                aes(x = readiness, y = vulnerability, label = iso_a3),
                color = "white", fontface = "bold", size = 3) +
      # Scales
      scale_fill_gradient(
        name = "Risk\nScore",
        low = "#ffffcc", high = "#800026",
        guide = guide_colorbar(
          barwidth = 0.8,
          barheight = 4
        )
      ) +
      scale_x_continuous(
        name = "Readiness to Adapt →",
        limits = c(0.25, 0.5),
        breaks = seq(0.25, 0.5, 0.05),
        labels = function(x) sprintf("%.2f", x)
      ) +
      scale_y_continuous(
        name = "Vulnerability →",
        limits = c(0.4, 0.6),
        breaks = seq(0.4, 0.6, 0.05),
        labels = function(x) sprintf("%.2f", x)
      ) +
      # Quadrant lines
      geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray70") +
      geom_vline(xintercept = 0.375, linetype = "dashed", color = "gray70") +
      # Annotations
      annotate("text", x = 0.45, y = 0.41, label = "Lower Risk\n(Low Vuln, High Ready)", 
               size = 3, color = "gray60", hjust = 0.5) +
      annotate("text", x = 0.30, y = 0.59, label = "Higher Risk\n(High Vuln, Low Ready)", 
               size = 3, color = "red", hjust = 0.5) +
      labs(
        title = "Vulnerability vs. Readiness",
        subtitle = "Target countries emphasized"
      ) +
      theme_minimal() +
      theme(
        plot.title = element_text(size = 14, hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(size = 12, hjust = 0.5, color = "gray30"),
        legend.position = "right"
      )
    
    return(p3)
    
  }, error = function(e) {
    cat(sprintf("Error creating scatter plot: %s\n", e$message))
    return(NULL)
  })
}

# Create all visualizations
cat("Creating vulnerability assessment visualizations...\n")

vuln_map <- create_vulnerability_map()
risk_map <- create_risk_map()
scatter_plot <- create_scatter_plot()

if (!is.null(vuln_map) && !is.null(risk_map) && !is.null(scatter_plot)) {
  # Combine the maps and scatter plot
  combined_viz <- (vuln_map + risk_map) / scatter_plot +
    plot_layout(heights = c(2, 1)) +
    plot_annotation(
      title = "Southern Africa Climate Vulnerability Assessment",
      subtitle = "ND-GAIN Index with integrated climate risk analysis - Emphasizing Malawi, South Africa & Zimbabwe",
      caption = "Data: ND-GAIN Country Index 2023, CMIP6 Climate Projections, IPCC AR6. Target countries shown with thick borders.",
      theme = theme(
        plot.title = element_text(size = 18, hjust = 0.5, face = "bold"),
        plot.subtitle = element_text(size = 14, hjust = 0.5, color = "gray30"),
        plot.caption = element_text(size = 10, hjust = 0.5, color = "gray50")
      )
    )
  
  # Save the combined visualization
  ggsave("southern_africa_vulnerability_assessment.png", 
         plot = combined_viz,
         width = 16, height = 12, 
         dpi = 300, 
         bg = "white")
  
  ggsave("southern_africa_vulnerability_assessment.svg", 
         plot = combined_viz,
         width = 16, height = 12, 
         bg = "white")
  
  cat("Vulnerability assessment visualization saved successfully!\n")
  
  # Print summary statistics
  cat("\nVulnerability summary for target countries:\n")
  target_summary <- vulnerability_data %>%
    filter(target_country == TRUE) %>%
    arrange(desc(risk_score)) %>%
    select(country, vulnerability, readiness, temp_stress_2050, precip_stress_2050, risk_score)
  
  print(target_summary)
  
  cat("\nRisk ranking:\n")
  for(i in 1:nrow(target_summary)) {
    row <- target_summary[i,]
    cat(sprintf("%d. %s - Risk Score: %.2f (Vuln: %.3f, Ready: %.3f, Temp: +%.1f°C, Precip: %+d%%)\n", 
                i, row$country, row$risk_score, row$vulnerability, row$readiness, 
                row$temp_stress_2050, row$precip_stress_2050))
  }
  
} else {
  cat("Failed to create vulnerability visualizations\n")
}